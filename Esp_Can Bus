#include <SPI.h>
#include <mcp_can.h>
#include <WiFi.h>
#include <PubSubClient.h>

// ---------------------------
// PIN connections for MCP2515
// ---------------------------
const int SPI_CS_PIN = 5;
const int CAN_INT_PIN = 2; // optional interrupt pin

MCP_CAN CAN(SPI_CS_PIN);

// ---------------------------
// WiFi & MQTT settings
// ---------------------------
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";
const char* mqtt_server = "192.168.1.100"; // contoh broker MQTT lokal
const int   mqtt_port = 1883;
const char* mqtt_user = "YOUR_MQTT_USERNAME"; 
const char* mqtt_pass = "YOUR_MQTT_PASSWORD";
const char* gokart_id = "gokart_01"; // ID unik gokart ini

const char* telemetry_topic = "gokart/telemetry/data";
const char* command_topic = "gokart/commands/pit_driver";

WiFiClient espClient;
PubSubClient client(espClient);

unsigned long lastMsg = 0;
#define MSG_BUFFER_SIZE (200)
char msg[MSG_BUFFER_SIZE];

// ---------------------------
// Telemetry data structure
// ---------------------------
struct TelemetryData {
  unsigned long timestamp_ms; // milliseconds from boot
  int rpm;
  float speed;
  float motorTemp;
  float voltage;
  float current;
};

TelemetryData gokartData;

// ---------------------------
// Gokart constants
// ---------------------------
float wheel_diameter_m = 0.3;
float gear_ratio = 5.0;

// ---------------------------
// Function Prototypes
// ---------------------------
void setup_wifi();
void reconnect_mqtt();
void callback(char* topic, byte* payload, unsigned int length);
void send_telemetry();
void read_can_data();

// ------------------------------------
// SETUP
// ------------------------------------
void setup() {
  Serial.begin(115200);

  // Init CAN bus MCP2515
  while (CAN_OK != CAN.begin(MCP_ANY, CAN_500KBPS, MCP_8MHZ)) {
    Serial.println("CAN BUS init failed, retrying...");
    delay(500);
  }
  Serial.println("CAN BUS init ok!");

  setup_wifi();
  client.setServer(mqtt_server, mqtt_port);
  client.setCallback(callback);
}

// ------------------------------------
// MAIN LOOP
// ------------------------------------
void loop() {
  if (WiFi.status() != WL_CONNECTED) {
    setup_wifi(); // Reconnect WiFi if disconnected
  }
  
  if (!client.connected()) {
    reconnect_mqtt();
  }
  client.loop();

  unsigned long now = millis();
  if (now - lastMsg > 100) { // 100 ms publish interval
    lastMsg = now;
    read_can_data();
    send_telemetry();
  }
}

// ------------------------------------
// WIFI SETUP
// ------------------------------------
void setup_wifi() {
  delay(10);
  Serial.print("Connecting to ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println();
  Serial.println("WiFi connected, IP address: ");
  Serial.println(WiFi.localIP());
}

// ------------------------------------
// MQTT reconnect
// ------------------------------------
void reconnect_mqtt() {
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection...");
    String clientId = "ESP32GokartClient-";
    clientId += String(random(0xffff), HEX);
    if (client.connect(clientId.c_str(), mqtt_user, mqtt_pass)) {
      Serial.println("connected");
      client.subscribe(command_topic);
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      Serial.println(" retry in 5s");
      delay(5000);
    }
  }
}

// ------------------------------------
// MQTT callback
// ------------------------------------
void callback(char* topic, byte* payload, unsigned int length) {
  Serial.print("MQTT Message [");
  Serial.print(topic);
  Serial.print("] ");
  String message = "";
  for (int i = 0; i < length; i++) {
    Serial.print((char)payload[i]);
    message += (char)payload[i];
  }
  Serial.println();

  if (String(topic) == command_topic) {
    if (message == "PIT_IN") {
      Serial.println(">> Command PIT IN received!");
    }
  }
}

// ------------------------------------
// READ CAN DATA from VESC
// ------------------------------------
void read_can_data() {
  long unsigned int rxId;
  unsigned char len = 0;
  unsigned char rxBuf[8];

  while (CAN_MSGAVAIL == CAN.checkReceive()) {
    CAN.readMsgBuf(&rxId, &len, rxBuf);

    int VESC_ID = 1;
    int STATUS = 0x090 + VESC_ID;
    int STATUS_2 = 0x091 + VESC_ID;
    int STATUS_3 = 0x092 + VESC_ID;

    if (rxId == STATUS) {
      int32_t rpm = ((int32_t)rxBuf[0] << 24) | ((int32_t)rxBuf[1] << 16) | ((int32_t)rxBuf[2] << 8) | (int32_t)rxBuf[3];
      int16_t current = ((int16_t)rxBuf[4] << 8) | rxBuf[5];
      
      // Update data struct
      gokartData.rpm = rpm;
      gokartData.current = current / 10.0;
    }
    else if (rxId == STATUS_2) {
      int16_t tempMos = ((int16_t)rxBuf[0] << 8) | rxBuf[1];
      int16_t tempMot = ((int16_t)rxBuf[2] << 8) | rxBuf[3];
      
      // Update data struct
      gokartData.motorTemp = tempMot / 10.0;
    }
    else if (rxId == STATUS_3) {
      int32_t battVoltage = ((int32_t)rxBuf[2] << 24) | ((int32_t)rxBuf[3] << 16) | ((int32_t)rxBuf[4] << 8) | (int32_t)rxBuf[5];
      
      // Update data struct
      gokartData.voltage = battVoltage / 100.0;
      // Note: We're not using battCurrent to avoid redundancy
    }
  }

  // Calculate speed only after reading all available data
  float wheel_circumference = wheel_diameter_m * 3.1416;
  float motor_rps = gokartData.rpm / 60.0;
  float wheel_rps = motor_rps / gear_ratio;
  gokartData.speed = wheel_rps * wheel_circumference;
}

// ------------------------------------
// SEND TELEMETRY via MQTT
// ------------------------------------
void send_telemetry() {
  gokartData.timestamp_ms = millis();

  // Format with gokart ID and timestamp
  snprintf(msg, MSG_BUFFER_SIZE, "%s,%lu,%d,%.2f,%.2f,%.2f,%.2f",
           gokart_id,
           gokartData.timestamp_ms,
           gokartData.rpm,
           gokartData.speed,
           gokartData.motorTemp,
           gokartData.voltage,
           gokartData.current);

  Serial.print("Publishing: ");
  Serial.println(msg);
  client.publish(telemetry_topic, msg);
}
